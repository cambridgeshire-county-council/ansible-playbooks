---
- name: Create backup folder
  hosts: localhost
  connection: local

  tasks:
   - name: Get ansible date/time facts
     setup:
       filter: "ansible_date_time"
       gather_subset: "!all"

   - name: Store DTG as fact
     set_fact:
       DTG: "{{ ansible_date_time.date }}"

   - name: Create Directory {{hostvars.localhost.DTG}}
     file:
      path: ~/backups/{{hostvars.localhost.DTG}}
      state: directory
  run_once: true

- name: Gather Switch info 
  hosts: switches
  vars_files: vars/image_list.yml
  tasks:
    - name: Gather info
      cisco.ios.ios_facts:
        gather_subset: min
      register: facts
    
    - name: Run command to get free space
      ios_command:
        commands:
          - show file systems
        wait_for:
          - result[0] contains flash
      register: result
    
    - set_fact:
        free_space: "{{ (result.stdout | regex_findall('(\\d*)\\s*[a-z]*\\s*[a-z]*\\s*flash:'))[0]}}"
        model: "{{ (facts.ansible_facts.ansible_net_image | regex_search('.*:(.*)-.*','\\1'))[0] }}"
        current_image: "{{ (facts.ansible_facts.ansible_net_image| regex_search('.*:(.*)','\\1'))[0] }}"
    
    - set_fact:
        latest_image: "{{ images[model]['image_name'] }}"
        image_filesize: "{{ images[model]['filesize'] }}"
        image_checksum: "{{ images[model]['checksum'] }}"
    
    - name: Check boot image is different
      assert:
        that: current_image != latest_image 
        success_msg: "{{ current_image }} is different to {{ latest_image }}, switch will be patched"
        fail_msg: "Current switch image is {{ current_image }}, which is the same as {{ latest_image }}, so upgrade will not take place"
    
    - name: Check free space available
      assert:
        that:
          - "{{ free_space | int }} > {{ image_filesize | int }}"
        success_msg: Enough free space to copy file. Filesize is {{ hostvars['localhost']['file_size'] }}b and {{ free_space }}b available
        fail_msg: Not enough free space to copy file. Filesize is {{ hostvars['localhost']['file_size'] }}b and only {{ free_space }}b available
        quiet: false
    
    - name: check if image already exists on disk
      file:
        path: "flash:/{{ latest_image }}"
        state: file
      register: file_status
    
    - name: copy image
      ios_command:
        commands:
        - "copy tftp://134.22.15.8/{{ model }}/{{ latest_image }} flash:"
      when: 
        - current_image != latest_image
        - not(file_status.stat.exists)
        - free_space > image_filesize

    - name: Check MD5 checksum of copied file
      ios_command:
        commands:
          - "verify /md5 flash:{{ image_name }}"
        wait_for: result[0] contains Done
      register: result
      when: 
        - current_image != latest_image

    - name: check md5 checksum matches
      assert:
        that: result.stdout[0][-32:] == hostvars['localhost']['md5_checksum']
        success_msg: File copy succeeded, copied file checksum {{ result.stdout[0][-32:] }} matches original checksum {{ hostvars['localhost']['md5_checksum'] }}
        fail_msg: File copy failed, copied file checksum {{ result.stdout[0][-32:] }} different from original checksum {{ hostvars['localhost']['md5_checksum'] }}
      when: 
        - current_image != latest_image

    - name: Change Boot Variable to new image 
      ios_config: 
        commands: 
          - "boot system flash:{{ image_name }}"
        save_when: always 
       when: 
         - current_image != latest_image

    - name: Reload the Device
      cli_command: 
        command: reload
        prompt: 
          - confirm
        answer: 
          - 'y'
      when: 
        - current_image != latest_image
         
    - name: Wait for device to come back online
      wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        delay: 90
      delegate_to: localhost
      when: 
        - current_image != latest_image

    # Check current image 
    - name: Check Image Version      
      ios_facts:
    - set_fact:
        current_image: "{{ (facts.ansible_facts.ansible_net_image| regex_search('.*:(.*)','\\1'))[0] }}"
    - debug: 
        msg: 
        - "Current boot image is {{ current_image }}"

    - name: Assert upgrade complete
      assert:
        that:
          - latest_image == current_image
    - debug: 
        msg: 
        - "Software Upgrade has been completed"
